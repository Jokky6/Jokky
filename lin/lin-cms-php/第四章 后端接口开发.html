<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第四章 后端接口开发 | Lin Books</title>
    <meta name="description" content="This is Lin books">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.a7d203bd.css" as="style"><link rel="preload" href="/assets/js/app.692f6a03.js" as="script"><link rel="preload" href="/assets/js/2.a2f7efd9.js" as="script"><link rel="preload" href="/assets/js/15.05f6edb8.js" as="script"><link rel="preload" href="/assets/js/4.9374ee9c.js" as="script"><link rel="preload" href="/assets/js/13.4d441c52.js" as="script"><link rel="preload" href="/assets/js/12.c861f4d7.js" as="script"><link rel="prefetch" href="/assets/js/10.c87da524.js"><link rel="prefetch" href="/assets/js/11.f912f175.js"><link rel="prefetch" href="/assets/js/14.bf7bfdc1.js"><link rel="prefetch" href="/assets/js/16.5b48ad25.js"><link rel="prefetch" href="/assets/js/17.646786dd.js"><link rel="prefetch" href="/assets/js/18.f2479593.js"><link rel="prefetch" href="/assets/js/19.cef3a76b.js"><link rel="prefetch" href="/assets/js/20.e102ff37.js"><link rel="prefetch" href="/assets/js/21.af10237c.js"><link rel="prefetch" href="/assets/js/22.2d6bc279.js"><link rel="prefetch" href="/assets/js/23.6fc9562d.js"><link rel="prefetch" href="/assets/js/24.b1047d55.js"><link rel="prefetch" href="/assets/js/25.7247b7c2.js"><link rel="prefetch" href="/assets/js/26.47d0a6d6.js"><link rel="prefetch" href="/assets/js/27.97f8ca0a.js"><link rel="prefetch" href="/assets/js/28.a916f916.js"><link rel="prefetch" href="/assets/js/29.36077ef7.js"><link rel="prefetch" href="/assets/js/3.b4b8313d.js"><link rel="prefetch" href="/assets/js/30.daf4eaad.js"><link rel="prefetch" href="/assets/js/31.85211272.js"><link rel="prefetch" href="/assets/js/32.b501c42c.js"><link rel="prefetch" href="/assets/js/33.5f05f8ef.js"><link rel="prefetch" href="/assets/js/5.9bc7c4fb.js"><link rel="prefetch" href="/assets/js/6.4a6fbe1b.js"><link rel="prefetch" href="/assets/js/7.3afbe7e5.js"><link rel="prefetch" href="/assets/js/8.4c9562f2.js"><link rel="prefetch" href="/assets/js/9.75b26b74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a7d203bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-76b5edba><header class="navbar" data-v-76b5edba><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" placeholder="请输入搜索内容" value=""> <!----></div> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/lin/lin-ui/" class="nav-link">微信小程序入门与实践（第二版）</a></div><div class="nav-item"><a href="/lin/lin-cms-koa2/" class="nav-link">koa2实战</a></div><div class="nav-item"><a href="/lin/lin-cms-php/" class="nav-link router-link-active">lin-cms-php&amp;Vue教程</a></div> <!----></nav> <div class="logo can-show" data-v-7dfc7a80><img src="/left-logo.png" alt="Lin Books" class="image" data-v-7dfc7a80></div></div></header> <div class="sidebar-mask" data-v-76b5edba></div> <aside class="sidebar normal" data-v-76b5edba><!----> <!----> <!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/lin/lin-ui/" class="nav-link">微信小程序入门与实践（第二版）</a></div><div class="nav-item"><a href="/lin/lin-cms-koa2/" class="nav-link">koa2实战</a></div><div class="nav-item"><a href="/lin/lin-cms-php/" class="nav-link router-link-active">lin-cms-php&amp;Vue教程</a></div> <!----></nav> <div class="logo" data-v-7dfc7a80 data-v-76b5edba><img src="/left-logo.png" alt="Lin Books" class="image" data-v-7dfc7a80></div> <div class="info-container" data-v-76b5edba><div class="content__author" data-v-76b5edba><div class="author-container" data-v-4cbd787c><img src="../../../php-author.png" alt="头像" class="avatar" data-v-4cbd787c> <div class="author-info" data-v-4cbd787c><p name="沁塵" class="name" data-v-4cbd787c>沁塵</p> <span job="不知名公司项目经理" class="job" data-v-4cbd787c>不知名公司项目经理</span></div></div></div> <div class="content__adverse" data-v-76b5edba><div class="adverse" data-v-39c8d1c7><div class="book-name" data-v-39c8d1c7>Lin CMS PHP&amp;Vue教程</div> <!----></div></div></div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>lin-cms-php</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/lin/lin-cms-php/" class="sidebar-link">前言</a></li><li><a href="/lin/lin-cms-php/第一章 关于教程.html" class="sidebar-link">第一章 关于教程</a></li><li><a href="/lin/lin-cms-php/第二章 开发环境搭建.html" class="sidebar-link">第二章 开发环境搭建</a></li><li><a href="/lin/lin-cms-php/第三章 原型APP内容需求梳理.html" class="sidebar-link">第三章 内容需求梳理</a></li><li><a href="/lin/lin-cms-php/第四章 后端接口开发.html" class="active sidebar-link">第四章 后端接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lin/lin-cms-php/第四章 后端接口开发.html#后端目录结构" class="sidebar-link">后端目录结构</a></li><li class="sidebar-sub-header"><a href="/lin/lin-cms-php/第四章 后端接口开发.html#准备工作" class="sidebar-link">准备工作</a></li><li class="sidebar-sub-header"><a href="/lin/lin-cms-php/第四章 后端接口开发.html#轮播图管理" class="sidebar-link">轮播图管理</a></li></ul></li></ul></section></li></ul> </aside> <main class="page" data-v-76b5edba> <div class="main-page"><div class="content__default"><h1 id="第四章-后端接口开发"><a href="#第四章-后端接口开发" aria-hidden="true" class="header-anchor">#</a> 第四章 后端接口开发</h1> <h2 id="后端目录结构"><a href="#后端目录结构" aria-hidden="true" class="header-anchor">#</a> 后端目录结构</h2> <p>在正式开始开发之前，我先来熟悉下lin-cms-tp5的目录结构。运行PhpStorm，在开发工具中打开lin-cms-tp5的所在目录。在开发工具左边的资源管理中我们会看到大概如下的目录结构：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>根目录
├─application           应用目录
│  ├─api                模块目录
│  │  ├─behavior        行为目录
│  │  ├─controller      控制层目录
│  │  │  ├─cms          开发CMS API目录
│  │  │  └─v1           开发普通API目录
│  │  ├─model           模型层目录
│  │  └─validate        验证器目录
│  ├─http               模块目录
│  │  └─middleware      中间件目录
│  ├─index              模块目录
│  │  └─controller      控制层目录
│  ├─lib                类库文件目录
│  │  ├─auth            权限校验类库目录
│  │  ├─exception       自定义异常类库目录
│  │  ├─file            文件上传类库目录
│  │  └─token           令牌类库目录
│  │
│  ├─provider.php       应用容器绑定定义文件
│  ├─command.php        命令行定义文件
│  ├─common.php         公共函数文件
│  └─tags.php           应用行为扩展定义文件
│
├─config                应用配置目录
│  ├─app.php            应用配置
│  ├─cache.php          缓存配置
│  ├─cookie.php         Cookie配置
│  ├─database.php       数据库配置
│  ├─log.php            日志配置
│  ├─session.php        Session配置
│  ├─template.php       模板引擎配置
│  └─trace.php          Trace配置
│
├─route                 路由定义目录
│  ├─route.php          路由定义
│  └─<span class="token punctuation">..</span>.                更多
│
├─public                WEB目录（对外访问目录）
│  ├─index.php          入口文件
│  ├─router.php         快速测试文件
│  └─.htaccess          用于apache的重写
│
├─thinkphp              框架系统目录
│  ├─lang               语言文件目录
│  ├─library            框架类库目录
│  │  ├─think           Think类库包目录
│  │  └─traits          系统Trait目录
│  │
│  ├─tpl                系统模板目录
│  ├─base.php           基础定义文件
│  ├─convention.php     框架惯例配置文件
│  ├─helper.php         助手函数文件
│  └─logo.png           框架LOGO文件
│
├─extend                扩展类库目录
├─runtime               应用的运行时目录（可写，可定制）
├─vendor                第三方类库目录（Composer依赖库）
├─build.php             自动生成定义文件（参考）
├─composer.json         composer 定义文件
├─LICENSE.txt           授权说明文件
├─README.md             README 文件
└─think                 命令行入口文件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><blockquote><p>现阶段不着急一下子理解每一个目录作用和含义，有些目录随着我们开发的深入会用到，到时候再详细讲解；有些目录则是TP5框架或者开源项目作者为了实现某些功能而定义的，一般情况下并不需要我们关心。</p></blockquote> <p>这里我们重点关注的是<code>application\api</code>这个模块目录，在该目录下，有<code>behavior</code>、<code>controller</code>、<code>model</code>、<code>validate</code>，四个目录，其中<code>controller</code>、<code>model</code>、<code>validate</code>，这三个目录会是接下来后端开发过程中经常要打交道的目录，以下逐个进行介绍：</p> <ul><li>controller</li></ul> <p><code>controller</code>目录就是我们前面章节中介绍的控制层，在这个目录下我们会放置很多控制器类，前端在请求一个具体的<code>url</code>地址后，框架的<code>路由</code>机制根据我们定义的路由规则，把这个请求路由到对应的控制器类。</p> <blockquote><p>路由是什么？打个比方，有一栋写字楼，里面有很多公司，你来到大厦的前台，问：请问XXXX公司在哪里？前台翻了一翻手上的登记本，答：前面左转上电梯X楼XXXX号，然后你就奔那而去了。这里面大厦就好比后端在运行的系统，前台就起到了一个路由的功能，前台根据你问的公司名字(接口地址，是一个url)查登记本(路由定义文件，里面定义了不同url所对应的控制器)，然后指引你去到目的地(转发到指定的控制器)。当然，如果前台发现你这个公司并不存在，就会告诉你，抱歉，这里没有这家公司（熟悉的404页面）。</p></blockquote> <p><code>controller</code>目录下又分了<code>cms</code>和<code>v1</code>两个子目录，这两个子目录并不是必须，但是推荐这么做。这么做的目的就是为了区分不同的控制器类型便于日后管理和维护。<code>cms</code>目录下，我们只定义跟具体业务无关的控制器，比如新建管理账号、分组等等;<code>v1</code>则定义跟具体业务有关的控制器，在项目源码中给出了一个关于<code>图书管理</code>的示例控制器。</p> <blockquote><p>v1目录同时也充当了一个版本号的作用。在真实业务开发场景中，随着功能的迭代发展，我们可能会开发一套新接口，v2的版本，但是原接口出于某些原因不能直接废弃掉，这时候我们就可以创建一个v2的目录，在里面写新的控制器，让新旧接口并存。但无论是V多少，都应该是和具体业务有关的，后续我们的开发都是基于v1目录。</p></blockquote> <ul><li>model</li></ul> <p><code>model</code>目录就使我们前面章节中介绍的模型层，在这个目录下我们会放置很多模型类，用来封装数据模型或者和数据库打交道。</p> <ul><li>validate</li></ul> <p><code>validate</code>目录是用来放置自定义验证器类用的。在真实开发场景中，数据校验都是必不可少的环节，而且是双重（甚至多重）的校验，即前端需要校验（比如说一个前端页面有一个表单，前端要校验输入的内容是否合法，不合法就不给提交，这时候还没向后端发起请求）；前端校验通过了，数据到了后端，后端在正式执行业务逻辑之前也要再校验一次，通过了才会继续走业务逻辑。这里自定义验证器类的作用就是用来验证前端提交过来的数据，校验通过则继续执行业务逻辑，校验不通过则抛出一个异常信息告知前端。</p> <blockquote><p>就如同产品经理永远想象不到用户会怎么使用自己的产品一样，你也想象不到用户会利用前端给你提交了什么，无论是有意还是无意，所以谨记一点，永远不要相信前端或者用户提交的数据，一定要校验。</p></blockquote> <h2 id="准备工作"><a href="#准备工作" aria-hidden="true" class="header-anchor">#</a> 准备工作</h2> <ul><li>导入原型APP数据库表</li></ul> <p>原型APP的项目是有一套完整据库表的，这里我先导入这些表，方便我们后续的开发。数据库表我已经打包并放在了百度云：https://pan.baidu.com/s/1Ao7Wc25K2bt9OLwazX6doQ 密码：x6e2，已购买<a href="https://coding.imooc.com/class/97.html" target="_blank" rel="noopener noreferrer">《ThinkPHP5.0+小程序商城构建全栈应用》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>视频课程的读者可以跳过。</p> <p>下载完数据库表的打包文件后，启动你的WampServer并点击右下角的图标，选择<code>phpMyAdmin</code>并登陆。登陆后先点击我们前面创建好的<code>zerg</code>数据库，再点击界面右边上方菜单栏的<strong>导入</strong></p> <div class="img-container"><img src="/assets/img/lin-tp-db-1.6e9421c0.png" class="full-img"></div> <p>进入导入的页面后，点击<strong>选择文件</strong>，选中刚刚下载下来的<code>zerg.sql</code>文件并确定，然后拉到页面最下方，点击<strong>执行</strong>，一切顺利的话你会看到</p> <div class="img-container"><img src="/assets/img/lin-tp-db-2.7f06b5a2.png" class="full-img"></div> <blockquote><p>具体每张表的作用这里不作解释，说了大家也记不住，后面实战开发的时候跟着需求实现来逐个击破。</p></blockquote> <h2 id="轮播图管理"><a href="#轮播图管理" aria-hidden="true" class="header-anchor">#</a> 轮播图管理</h2> <h3 id="查询所有轮播图"><a href="#查询所有轮播图" aria-hidden="true" class="header-anchor">#</a> 查询所有轮播图</h3> <p>首先我们来实现一个可以查询所有轮播图的接口。在控制层新建一个Banner控制器，右键<code>controller/v1</code>目录，在弹出菜单中选择New——PHP Class，在name输入框这里输入<code>Banner</code>然后回车</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-1.7751098c.png" class="full-img"></div> <p>这里开发工具已经帮我们自动生成了一些基础代码，接下来我们来为这个控制器实现一个<code>getBanners()</code>方法，这个方法用于获取所有轮播图。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>前面<a href="##%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">准备工作</a>环节我们已经把原型APP的数据库表导入到了数据库中做为素材，其中就包括Banner，那么现在我们就来尝试读取这部分数据。</p> <p>在正式进行读取Banner数据之前，我们先打开phpMyAdmin并点击<code>zerg</code>数据库，点击后会显示该数据库下所有已存在的表，你会发现有<code>banner</code>和<code>banner_item</code>两张表。那么我们该读取哪张表呢？答案是两张都要读。<code>banner</code>和<code>banner_item</code>是一种关联关系，一个<code>banner</code>对应多个<code>banner_item</code>，专业点来说就是表的<code>一对多</code>关系。</p> <blockquote><p>为什么要这么设计呢？一个轮播图里面有多少个要轮播的内容是不确定的，假如用一张表实现，你设置5个字段分别用于存放轮播图的内容，那么如果有一天你需要轮播的内容为6个，你只能通过加字段的方式，后面还可能会有7个8个等等，你要不停的加字段。然后你又不是每个轮播图都有那么多的内容需要轮播，那多出来的字段就等于浪费了空间。</p></blockquote> <p>那么如何定义两张表是关联的关系呢？我们分别打开两张表，你会发现在<code>banner_item</code>表中，有一个<code>banner_id</code>字段，这个字段的值对应了<code>banner</code>表中的某一条记录的<code>id</code>字段的值。比如现在<code>banner_item</code>表中就有4条记录，他们的<code>banner_id</code>都为<code>1</code>，代表了这几个item都是属于<code>banner</code>表中id为<code>1</code>的banner。当然光是这样定义还是不够的，我们还需要借助TP5框架中的<code>模型关联</code>来实现<code>关联查询</code>，但表字段的预先定义是前提。了解了表的关系和字段内容之后，我们马上通过代码来实现查询所有轮播图的功能。</p> <p>要查询数据库，写SQL语句？不存在的，我们用<code>模型</code>！首先需要在模型层分别新建<code>Banner</code>和<code>BannerItem</code>模型。右键<code>api/model</code>目录，在弹出菜单中选择New——PHP Class，在name输入框这里输入<code>Banner</code>然后回车，再重复同样操作<code>BannerItem</code>模型。</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-2.51c8035f.png" class="full-img"></div> <p>要让模型对应到数据库中的某张表，我还需要让模型类继承TP5框架的<code>Model</code>类。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Banner</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BannerItem</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>模型的类名必须与数据库表的表名一致才能对应上，类名必须是驼峰形式且大写开头。</p></blockquote> <p>模型定义好了之后，回到我们的Banner控制器下，在前面创建的<code>getBanners()</code>中我们来调用模型进行查询:</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 调用了TP5框架数据库模型的select()方法</span>
        <span class="token comment">// 该方法用于查询表的所有记录</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> \<span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Banner</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回查询结果给前端</span>
        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这里Banner模型调用的时候IDE（开发工具）已经智能感知到了模型类，但是回车后发现这代码有点惨不忍睹，这是因为模型类名和控制器的类名冲突了，所以自动帮我们以完整的<code>命名空间</code>的方式调用，为了兼顾代码的可读性和美观，我们需要稍微处理下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>
<span class="token comment">// use这个模型类，并用as指定一个别名</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Banner</span> <span class="token keyword">as</span> BannerModel<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> BannerModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>完美！然后我们怎么请求这个接口以验证是否符合我们的预期呢？前面我们说到了，要请求接口，必须要有地址，事不宜迟，我们来给这个接口定义一个路由地址。</p> <p>双击IDE左边资源管理中根目录下的<code>route\route.php</code>，可以看到里面已经存在很多路由，TP5框架定义路由的方法是使用内置的<code>Route</code>类：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cms'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// CMS管理相关的路由规则</span>
        <span class="token comment">// 内容省略。。。。</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'v1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 业务接口相关的路由规则</span>
        <span class="token comment">// 内容省略。。。。</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'Auth'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ReflexValidate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allowCrossDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>按照lin-cms-tp5框架的推荐，我们在v1目录下定义了控制器，同样的，我这里也在<code>v1</code>这个<code>路由分组</code>下定义路由规则，原有的图书管理相关路由可以删除掉：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'cms'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// CMS管理相关的路由规则</span>
        <span class="token comment">// 内容省略。。。。</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'v1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 业务接口相关的路由规则</span>
        Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'banner'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'api/v1.Banner/getBanners'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'Auth'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'ReflexValidate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allowCrossDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>为了整个路由定义内容有结构性和归纳性，我们在<code>v1</code>这个路由分组下，使用<code>Route::group()</code>方法再嵌套一个<code>路由分组</code>，分组名为<code>banner</code>。</p> <blockquote><p>分组名会做为url地址的一部分，从最顶层的分组名往下拼接，这里的顶层分组名为空，表示<code>/</code>，即域名根地址，接着是v1，即<code>/v1</code>，再往下是我们的banner,即最终的规则是<code>/v1/banner</code></p></blockquote> <p>在分组里面，我们定义一条请求类型为GET的路由，<code>get()</code>方法这里我们传递两个参数，第一个是路由规则，第二个是该路由要执行的操作，这里第一个参数我们设置为空，表示当访问了<code>web服务器地址/v1/banner</code>这个地址的时候，就去执行<code>api/v1.Banner/getBanners</code>方法(即我们在控制器中定义的getBanners())。</p> <p>现在控制器、模型、路由都定义好了，检查下我们的PHP内置web服务器是否依然在运行状态，如果没有，可以直接在PhpStorm中按下<code>Alt+F12</code>，这时候会在IDE里打开命令行工具（非常方便的一个功能，不用开多一个窗口），默认打开的路径就已经是项目根目录了，直接运行<code>php think run</code>启动PHP内置web服务器。</p> <p>接下来我们就要来试着访问这个接口，看看结果是否符合我们的预期。双击运行我们前面安装了的<code>Postman</code>，点击左侧的<code>+New Collection</code>，起个名字叫<code>lin-cms-tp5</code>（名字请随意），然后你就会看到下面多出来一个像文件夹一样的东西</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-3.c6f9ec18.png" class="full-img"></div> <p>把鼠标移动到刚刚创建的这个文件夹上，右下角会有三个小点，点击然后选择<code>Add Request</code>，会弹出一个窗口，按下图配置：</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-4.01d558e6.png" class="full-img"></div> <p>最后点击右下角的<code>save to 轮播图</code>，最终效果</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-5.ab2c7cad.png" class="full-img"></div> <p>以后我们每一个接口就按照这种方式，分门别类的设置好，方便我们后面使用。点击刚刚我们创建的请求，地址栏输入我们PHP内置web服务器的地址加上我们刚刚在路由配置文件里面配置的路由规则，然后点击<code>Send</code>按钮：</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-6.fb33c0e8.png" class="full-img"></div> <p>没有报错，接口正常返回了数据，但是数据的内容不大对，这里只返回了<code>banner</code>表中的内容，轮播图的具体内容<code>banner_item</code>没有返回。这是因为我们在查询的时候，只查询了Banner模型，那这里我们是不是要根据查询结果里面的id再去查询<code>Banner_item</code>模型呢？可以，但没必要！前面说了，我们有<code>关联查询</code>这种东西！要实现关联查询，除了表字段的预先定义，还需要在模型类中定义两个模型的关系。回到我们的代码中，打开Banner模型类，加入以下代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Banner</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>

    <span class="token comment">// 方法名可以自定义,通过在模型类里面定义一个方法，声明关联关系，这个方法返回被关联模型的实例</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 调用了模型实例的hasMany（）方法，这个方法定义了当前模型与被关联模型BannerItem是一种一对多的关系</span>
        <span class="token comment">// 关联的内容是BannerItem模型里banner_id属性的值与当前模型的id属性的值一致的记录。</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'BannerItem'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'banner_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>hasMany()方法中，第二个参数默认是当前模型的小写类名+_id，第三个参数默认是id，由于我们在设计表的时候已经考虑到了这点，所以这里可以直接缩写为：return $this-&gt;hasMany('BannerItem');读者在开发自己项目的时候也可以利用这一点小技巧。</p></blockquote> <p>定义完关联关系之后，回到我们的控制器方法<code>getBanners()</code>，稍作修改：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Banner</span> <span class="token keyword">as</span> BannerModel<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 在调用select()方法之前，先调用with()，并传入刚刚在模型类中定义的关联方法名。</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> BannerModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'items'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>回到<code>Postman</code>中，再次点击<code>Send</code>，得到结果如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页置顶&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页轮播图&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;25&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>这下子轮播图和所属元素就都查询出来了，原来的结果中多出了一个<code>items</code>的键，它的值是一个数组，数组的内容就是<code>banner_item</code>表中的内容。</p> <blockquote><p>不使用模型关联查询，意味着你需要先foreach一次select()的结果，然后在循环体里面根据结果里的id去查询BannerItemModel，还要拼装数组，这个过程既费时又很低效。</p></blockquote> <blockquote><p>思考题：上海实行了垃圾分类，市民们苦于分不清干垃圾、湿垃圾，技术人员小明决定开发一个APP让大家可以查询每个分类下面都有什么垃圾，请问这时候小明要如何设计数据库表。</p></blockquote> <p>到这里我们的接口并没有开发完成，仔细观察返回结果<code>item</code>键的值，里面并没有我们想象中该有的图片地址，只有一个<code>img_id</code>，这样的接口数据，前端是没办法得知你这个轮播图下面到底是什么图片内容。通过这个字段名的观察，我们很容易猜到了这里也是需要使用关联查询，是的，没错，<code>banner_item</code>表与<code>image</code>表也是存在表的关联关系。由于<code>img_id</code>是在<code>banner_item</code>表定义的，所以我要在BannerItem模型中去定义关联关系：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BannerItem</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">img</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 调用了模型实例的belongsTo()方法，这个方法定义了当前模型与被关联模型Image是一种相对关系</span>
        <span class="token comment">// 关联的内容是BannerItem模型里img_id属性的值与Image模型的id属性的值一致的记录。</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Image'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'img_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这里我们用<code>belongsTo（）</code>来定义模型关系。在TP5框架中，有个hasOne()的方法，通过调整参数，可以实现同样的效果，但是这里为什么不选择呢？我们可以看到<code>image</code>表中是没有任何类似<code>xxx_id</code>的字段的，因为这个表是公共的，我们有很多地方会到用到。对于<code>image</code>表来说，里面的图片是用于哪个功能模块的它并不关心，不能与某个表具体绑死在一起。所以我们在其他表中通过定义<code>img_id</code>字段来关联这个<code>image</code>表中记录，使用<code>belongsTo（）</code>来定义模型关联并查询。这样做的好处就是第一，语义化明确，has，拥有谁，belongs，属于谁，对于BannerItem模型来说，img_id是属于Image模型的，更符合语义化；第二就是可以保持<code>Image</code>表的足够通用和独立。</p> <blockquote><p>官方关于这个这个并没有太多的解释，称之为<code>相对关联</code>，这里权当参考。另外这里第二个参数不能省略，省略的话会以<code>banner_item_id</code>为默认参数，查询结果不会发生变化。</p></blockquote> <p>这里我们还没有创建<code>Image</code>模型，右键<code>api/model</code>目录，在弹出菜单中选择New——PHP Class，在name输入框这里输入<code>Image</code>然后回车，同样需要继承<code>Model</code>类：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Image</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>

<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>增加了BannerItem模型的关联定义和Image模型之后，再次回到控制器方法<code>getBanners</code>，稍作修改：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Banner</span> <span class="token keyword">as</span> BannerModel<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Banner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getBanners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// items代表了BannerItem模型的实例，.img的作用就是告知框架，还要调用items实例里的关联模型，即我们刚刚定义的img()</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> BannerModel<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'items.img'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>回到<code>Postman</code>，直接<code>Send</code>，得到如下结果：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页置顶&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页轮播图&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/banner-4a.png&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;25&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/banner-2a.png&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
           .......省略内容
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>和之前一样，<code>items</code>下数组里的每个元素都多出了一个<code>img</code>的键，值就是<code>Image</code>模型的内容。但是这里依然达不到我们预期的效果，<code>img</code>下<code>url</code>属性的值是一个<code>相对路径</code>，这种url地址提供给前端一样无法显示，在解决这个问题之前我们先搞清楚为什么<code>image</code>表里要这么存储数据。打开phpMyAdmin,找到<code>image</code>这张表，点击上方菜单的<code>结构</code>：</p> <div class="img-container"><img src="/assets/img/lin-tp-banner-7.3705a1d1.png" class="full-img"></div> <p>在真实业务开发场景中，我们的图片文件并不一定都是放在应用运行所在的服务器，有可能是阿里云、腾讯云，也有可能自己专门假设了一台图片服务器，还可能是由多台图片服务器组成的集群。也就是说这个图片地址有那么一部分是不确定的，所以我们在<code>url</code>字段中只存储确定的那一部分，通过<code>from</code>字段来标识这个图片是存在在哪里，然后我们在模型读取这个记录的时候，去判断这个<code>from</code>的值，根据不同的值来拼接这个<code>url</code>字段里的值。</p> <p>了解了设计初衷之后，我们就来从代码层面解决这个问题。解决思路就是在数据返回给前端之前，要先加工一下这个<code>url</code>字段，我们可能第一时间会想到就是用foreach循环，循环到了img这个元素，然后判断元素里面<code>from</code>的值，给个对应的url前缀拼接<code>url</code>字段。这样是可行的，但是没必要。我们需要用TP5框架模型内置的<code>获取器</code>这个功能。</p> <blockquote><p>官方解释：获取器的作用是对模型实例的（原始）数据做出自动处理。一个获取器对应模型的一个特殊方法（该方法必须为public类型），方法命名规范为：get+字段名（首字母大写）+Attr</p></blockquote> <p>因为这里我们需要对<code>Image</code>模型的数据做处理，所以我们在<code>Image</code>模型下定义一个获取器,打开<code>model/Image.php</code>加入以下代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Image</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 我们要获取url这个字段,获取默认接收两个参数</span>
    <span class="token comment">// $value是当前这条记录里url字段的值</span>
    <span class="token comment">// $data是当前记录的完整数据</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getUrlAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$finalUrl</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据表的注释，1来自本地，2来自公网</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'from'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 如果来自本地，把本机的存放图片目录的域名地址跟$value拼接</span>
            <span class="token comment">// 这里我们把本机的存放图片目录的域名地址写到了一个配置文件里。</span>
            <span class="token comment">// 后续我们可能换了域名或者目录，又或者有其他来源渠道，以配置文件的形式这样以后只需改配置文件而不必改动代码</span>
            <span class="token comment">// 利用TP5框架内置的助手函数config()快速指定获取配置文件下内容</span>
            <span class="token variable">$finalUrl</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'setting.img_prefix'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$value</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 这里如果from不是来自本地，那么存储的会是一个完整的公网访问地址，无需处理</span>
        <span class="token comment">// 返回处理后的url</span>
        <span class="token keyword">return</span> <span class="token variable">$finalUrl</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>别忘了创建一个配置文件，在IDE中，右键根目录下的<code>config</code>目录，选择New——PHP File,文件名写setting。创建好后，双击打开，添加如下内容：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'img_prefix'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'http://localhost:8000/public/images'</span><span class="token punctuation">,</span><span class="token shell-comment comment"># 仅做示例</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>配置文件必须放置在根目录下的config目录</p></blockquote> <p>回到我们的<code>Postman</code>中，再次点击<code>Send</code>发送请求：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页置顶&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页轮播图&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8000/public/images/banner-4a.png&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            .........省略后面重复内容
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>这里看到我们的<code>url</code>已经是一个完整的可访问地址了，前端在调用这个接口后，就可以直接通过读取这个url地址显示图片了。</p> <p>到这里，查询所有轮播图接口的开发就接近尾声了，最后我们来为这个接口做一些小小的优化。这里我们接口返回的数据中，有些字段前端其实并不需要，作为后端接口开发者，我们要从性能和安全的角度上对接口的返回数据进行控制。也许你又想着foreach了，但是这里同样不需要。TP5框架的模型类已经为我们提供了很方便的方法，这里以<code>Image</code>模型为例，IDE中打开我们的<code>Image</code>模型类，定义一个类的成员变量<code>$hidden</code>:</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>api<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Image</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$hidden</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'delete_time'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'from'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getUrlAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>通过给<code>$hidden</code>变量传递一个数组，数组里是要隐藏的字段名，这里我们传递<code>delete_time</code>和<code>from</code>字段。然后回到<code>Postman</code>再次发送一次请求；</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页置顶&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页轮播图&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img_id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                <span class="token property">&quot;key_word&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;delete_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;banner_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                <span class="token property">&quot;img&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8000/public/images/banner-4a.png&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            .........省略后面重复内容
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里可以看到，接口返回数据中，已经没有了<code>delete_time</code>和<code>from</code>字段。读者可以尝试在<code>Banner</code>和<code>BannerItem</code>中定义<code>$hidden</code>属性实现精简优化返回数据的内容。</p> <blockquote><p>扩展知识：<br>
模型关联，并不一定需要表中存在<code>id</code>与<code>xxx_id</code>字段，在定义模型关联的时候，可以自由利用两张表中的某个字段来实现，但是不推荐这么做，因为可读性太差。通过前面的实战我们可以发现，虽然我们在一开始并不了解整个项目的情况，但是通过字段名就可以大概判断出字段的用途，一个字段同时承载多个用途也不是正确的表字段设计方式。模型关联按我的理解就是在代码层面去实现关联表与表的关系，这就赋予了很多灵活性，而且一定程度上让开发者可以更少的接触数据库的东西（开发者需要关心数据库的东西，但是这个关心有点过度了）。而与之对应的，就是<code>外键</code>（也叫外键约束或者实体外键）了。在传统项目的数据库中，普遍使用<code>外键</code>来约束表与表的关联关系，直接从数据库层面定义死了。由于有了<code>外键</code>的存在，你在代码层面就必须保证表与表之间数据的一致性，不然会导致异常错误。同时在项目迭代过程中需要对涉及到存在<code>外键</code>的表进行调整，整个工作将会变得很复杂。这两种定义表关联关系没有说谁好谁坏，要看具体业务的应用场景，像银行这种，系统N年不更新，强调数据一致性，那么用<code>外键</code>是比较合适的；互联网行业，项目经常性迭代、重构，使用模型关联则更合适。</p></blockquote> <h3 id="新增轮播图"><a href="#新增轮播图" aria-hidden="true" class="header-anchor">#</a> 新增轮播图</h3> </div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新: </span> <span class="time">7/6/2019, 2:48:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/lin/lin-cms-php/第三章 原型APP内容需求梳理.html" class="prev">
          第三章 内容需求梳理
        </a></span> <!----></p></div> </div></main></div><div class="global-ui"><div data-v-262bdc3a data-v-262bdc3a><!----> <div class="wrap" data-v-262bdc3a></div> <!----></div></div></div>
    <script src="/assets/js/app.692f6a03.js" defer></script><script src="/assets/js/2.a2f7efd9.js" defer></script><script src="/assets/js/15.05f6edb8.js" defer></script><script src="/assets/js/4.9374ee9c.js" defer></script><script src="/assets/js/13.4d441c52.js" defer></script><script src="/assets/js/12.c861f4d7.js" defer></script>
  </body>
</html>
